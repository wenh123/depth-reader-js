/*!
MIT Licensed
https://github.com/DavisReef/depth-reader-js
XDM 1.0 spec: https://software.intel.com/en-us/articles/the-extensible-device-metadata-xdm-specification-version-10
Copyright (c)2015 Intel Corporation
*/
(function(){"use strict";function a(a,b,d,f){var k=c(f,"VendorInfo"),l=c(f,"DevicePose")||c(d,"DevicePose"),m=c(f,"CameraPose"),n=c(f,"Device")||c(d,"Device"),p=c(f,"Camera"),q=c(f,"Depthmap"),r=c(f,"NoiseModel"),s=c(f,"PerspectiveModel"),t=g(d,n,"Revision"),u=g(f,n,"VendorInfo")||g(d,n,"VendorInfo"),v=g(f,p,"VendorInfo"),w=g(f,n,"Pose")||g(d,n,"Pose"),x=g(f,p,"Pose"),y=e(g(f,p,"ImagingModel")),z=g(f,p,"Image"),A=e(g(f,p,"DepthMap")),B=g(A,r,"Reliability");a.revision=+j(f,n,"Revision")||+h(t,n,"Revision")||+i(t),a.device.vendor.manufacturer=j(u,k,"Manufacturer")||h(u,k,"Manufacturer"),a.camera.vendor.manufacturer=j(v,k,"Manufacturer")||h(v,k,"Manufacturer"),a.device.vendor.model=j(u,k,"Model")||h(u,k,"Model"),a.camera.vendor.model=j(v,k,"Model")||h(v,k,"Model"),a.device.pose.latitude=+j(w,l,"Latitude")||+h(w,l,"Latitude"),a.device.pose.longitude=+j(w,l,"Longitude")||+h(w,l,"Longitude"),a.device.pose.altitude=+j(w,l,"Altitude")||+h(w,l,"Altitude"),a.camera.pose.positionX=+j(x,m,"PositionX")||+h(x,m,"PositionX"),a.camera.pose.positionY=+j(x,m,"PositionY")||+h(x,m,"PositionY"),a.camera.pose.positionZ=+j(x,m,"PositionZ")||+h(x,m,"PositionZ"),a.camera.pose.rotationAxisX=+j(x,m,"RotationAxisX")||+h(x,m,"RotationAxisX"),a.camera.pose.rotationAxisY=+j(x,m,"RotationAxisY")||+h(x,m,"RotationAxisY"),a.camera.pose.rotationAxisZ=+j(x,m,"RotationAxisZ")||+h(x,m,"RotationAxisZ"),a.camera.pose.rotationAngle=+j(x,m,"RotationAngle")||+h(x,m,"RotationAngle"),a.perspective.focalLengthX=+j(y,s,"FocalLengthX")||+h(y,s,"FocalLengthX"),a.perspective.focalLengthY=+j(y,s,"FocalLengthY")||+h(y,s,"FocalLengthY"),a.perspective.principalPointX=+j(y,s,"PrincipalPointX")||+h(y,s,"PrincipalPointX"),a.perspective.principalPointY=+j(y,s,"PrincipalPointY")||+h(y,s,"PrincipalPointY"),a.depth.metric=o(j(A,q,"Metric")||h(A,q,"Metric")),a.depth.format=j(A,q,"Format")||h(A,q,"Format"),a.depth.near=+j(A,q,"Near")||+h(A,q,"Near"),a.depth.far=+j(A,q,"Far")||+h(A,q,"Far"),a.image.mime=j(z,b,"Mime")||h(z,b,"Mime"),a.depth.mime=j(A,q,"Mime")||h(A,q,"Mime"),a.confidence.mime=j(B,b,"Mime")||h(B,b,"Mime"),a.image.data=j(z,b,"Data")||h(z,b,"Data"),a.depth.data=j(A,q,"Data")||h(A,q,"Data"),a.confidence.data=j(B,b,"Data")||h(B,b,"Data")}function b(a,b,d,e){var f=c(e,"GDepth"),g=c(d,"GFocus");a.focus.focalPointX=+j(d,g,"FocalPointX"),a.focus.focalPointY=+j(d,g,"FocalPointY"),a.focus.focalDistance=+j(d,g,"FocalDistance"),a.focus.blurAtInfinity=+j(d,g,"BlurAtInfinity"),a.depth.format=j(d,f,"Format"),a.depth.near=+j(d,f,"Near"),a.depth.far=+j(d,f,"Far"),a.image.mime=j(d,b,"Mime"),a.depth.mime=j(d,f,"Mime"),a.image.data=j(e,b,"Data"),a.depth.data=j(e,f,"Data")}function c(a,b){return a&&a.getAttribute("xmlns:"+b)||""}function d(a){try{var b=new s,c=b.parseFromString(a,"application/xml");return e(f(c.documentElement))}catch(d){throw new Error("cannot parse XMP XML")}}function e(a){for(var b=a&&a.childNodes||[],c=b.length-1;c>=0;c--)if("rdf:Description"===b[c].nodeName)return b[c];return a}function f(a){for(var b=a&&a.firstChild;b&&1!==b.nodeType;b=b.nextSibling);return b||null}function g(a,b,c){var d=a&&a.getElementsByTagNameNS(b,c);return d&&d[0]||null}function h(a,b,c){return i(g(a,b,c))}function i(a){return a&&a.textContent||""}function j(a,b,c){return a&&a.getAttributeNS(b,c)||""}function k(a){a.mime&&a.data&&(a.data="data:"+a.mime+";base64,"+a.data)}function l(a,b){for(var c=b;c<a.length;c++)if(255===a[c]&&225===a[c+1])return c;return-1}function m(a,b){function c(c){var d=n(a,b,c.length);return c===d}return b+=2,c(x)?x:c(y)?y:""}function n(a,b,c){a=a.subarray(b,b+c);try{return String.fromCharCode.apply(null,a)}catch(d){for(var e=-1,f=a.length,g=new Array(f);++e<f;)g[e]=a[e];return String.fromCharCode.apply(null,g)}}function o(a){return!!String(a).match(/^\s*1|true|yes\s*$/i)}var p,q,r,s,t,u,v=this;"object"==typeof exports?(p="buffer",q=require("rsvp").Promise,r=require("xhr2"),s=require("xmldom").DOMParser,t=require("canvas"),u=t.Image):(p="arraybuffer",q=v.Promise||v.RSVP.Promise,r=v.XMLHttpRequest,s=v.DOMParser,u=v.Image);var w=function(){this.isXDM=!1,this.revision=0,this.device={vendor:{manufacturer:"",model:""},pose:{latitude:0,longitude:0,altitude:0}},this.camera={vendor:{manufacturer:"",model:""},pose:{positionX:0,positionY:0,positionZ:0,rotationAxisX:0,rotationAxisY:0,rotationAxisZ:0,rotationAngle:0}},this.perspective={focalLengthX:0,focalLengthY:0,principalPointX:0,principalPointY:0},this.focus={focalPointX:0,focalPointY:0,focalDistance:0,blurAtInfinity:0},this.image={mime:"",data:null},this.depth={metric:!1,format:"",near:0,far:0,mime:"",data:null},this.confidence={mime:"",data:null}};w.prototype.parseFile=function(e){var f=new Uint8Array(e);if(255!==f[0]||216!==f[1])throw new Error("file is not JPEG image");for(var g,h,i="",j="",o=0;-1<(o=l(f,o));)if(o+=2,h=m(f,o)){var p=x===h,q=h.length+(p?3:43),r=(f[o]<<8)+f[o+1]-q,s=o+q;o=s+r,g=n(f,s,r),p?i+=g:j+=g}this.debug&&(this.xmpXapXml=i,this.xmpExtXml=j);var t=d(i),u=d(j),v=c(u,"Image")||c(u,"GImage");this.isXDM=/xdm\.org/.test(v),(this.isXDM?a:b).call(null,this,v,t,u),k(this.image),k(this.depth),k(this.confidence)};var x="http://ns.adobe.com/xap/1.0/",y="http://ns.adobe.com/xmp/extension/";w.prototype.loadFile=function(a){var b=this;return new q(function(c,d){var e=new r;e.responseType=p,e.open("GET",a),e.onload=function(){if(this.response)try{b.parseFile.call(b,this.response),b.debug&&(b.fileData=this.response),c(b)}catch(a){d(a)}else{var e="cannot load file ["+this.status+"]";d(new Error(e))}},e.send()})},w.prototype.normalizeDepthmap=function(a){if(this.depth.data&&!this.depth._normalized){var b,c=new u;c.src=this.depth.data;var d=c.width,e=c.height;t?b=new t(d,e):(b=document.createElement("canvas"),b.width=d,b.height=e);var f=b.getContext("2d");f.drawImage(c,0,0);var g,h,i,j,k,l=f.getImageData(0,0,d,e),m=l.data,n=m.length,o=255,p=0;for(j=0;n>j;j+=4)g=m[j],g>p&&(p=g),o>g&&(o=g);var q=p- --o;for(j=0;n>j;j+=4)for(g=m[j],i!==g&&(h=Math.round((g-o)/q*255+a|0),h=Math.max(0,Math.min(255,h)),i=g),k=0;3>k;k++)m[j+k]=h;f.putImageData(l,0,0),this.depth.data=b.toDataURL(),this.depth._normalized=!0}},"object"==typeof exports?module.exports=w:v.DepthReader=w}).call(this);
//# sourceMappingURL=depth-reader.min.js.map